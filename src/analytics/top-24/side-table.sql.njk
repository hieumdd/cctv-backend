{%- import 'macro/filters.sql.njk' as filters %}

select
    *,
    ((ccs - day1_ccs) / day1_ccs) * 100 as per_chng_day1_ccs,
    ((ccs - day7_ccs) / day7_ccs) * 100 as per_chng_day7_ccs,
    ((ccs - day30_ccs) / day30_ccs) * 100 as per_chng_day30_ccs,
    ((ccr - day1_ccr) / day1_ccr) * 100 as per_chng_day1_ccr,
    ((ccr - day7_ccr) / day7_ccr) * 100 as per_chng_day7_ccr,
    ((ccr - day30_ccr) / day30_ccr) * 100 as per_chng_day30_ccr,
    ((total_followers - day1_total_followers) / day1_total_followers) * 100 as per_chng_day1_follower,
    ((total_followers - day7_total_followers) / day7_total_followers) * 100 as per_chng_day7_follower,
    ((total_followers - day30_total_followers) / day30_total_followers) * 100 as per_chng_day30_follower,
    ((linkedin_followers - day1_lif) / day1_lif) * 100 as per_chng_day1_lif,
    ((linkedin_followers - day7_lif) / day7_lif) * 100 as per_chng_day7_lif,
    ((linkedin_followers - day30_lif) / day30_lif) * 100 as per_chng_day30_lif,
    ((instagram_followers - day1_igf) / day1_igf) * 100 as per_chng_day1_igf,
    ((instagram_followers - day7_igf) / day7_igf) * 100 as per_chng_day7_igf,
    ((instagram_followers - day30_igf) / day30_igf) * 100 as per_chng_day30_igf,
    ((youtube_followers - day1_yts) / day1_yts) * 100 as per_chng_day1_yts,
    ((youtube_followers - day7_yts) / day7_yts) * 100 as per_chng_day7_yts,
    ((youtube_followers - day30_yts) / day30_yts) * 100 as per_chng_day30_yts,
    ((twitter_followers - day1_twf) / day1_twf) * 100 as per_chng_day1_twf,
    ((twitter_followers - day7_twf) / day7_twf) * 100 as per_chng_day7_twf,
    ((twitter_followers - day30_twf) / day30_twf) * 100 as per_chng_day30_twf,
    ((facebook_followers - day1_fbf) / day1_fbf) * 100 as per_chng_day1_fbf,
    ((facebook_followers - day7_fbf) / day7_fbf) * 100 as per_chng_day7_fbf,
    ((facebook_followers - day30_fbf) / day30_fbf) * 100 as per_chng_day30_fbf
from
    (
        select
            current_data.*,
            day1.ccs as day1_ccs,
            day1.ccr as day1_ccr,
            day1.linkedin_followers as day1_lif,
            day1.instagram_followers as day1_igf,
            day1.youtube_followers as day1_yts,
            day1.twitter_followers as day1_twf,
            day1.facebook_followers as day1_fbf,
            day1.total_followers as day1_total_followers,
            day7.ccs as day7_ccs,
            day7.ccr as day7_ccr,
            day7.linkedin_followers as day7_lif,
            day7.instagram_followers as day7_igf,
            day7.youtube_followers as day7_yts,
            day7.twitter_followers as day7_twf,
            day7.facebook_followers as day7_fbf,
            day7.total_followers as day7_total_followers,
            day30.ccs as day30_ccs,
            day30.ccr as day30_ccr,
            day30.linkedin_followers as day30_lif,
            day30.instagram_followers as day30_igf,
            day30.youtube_followers as day30_yts,
            day30.twitter_followers as day30_twf,
            day30.facebook_followers as day30_fbf,
            day30.total_followers as day30_total_followers,
        from
            (
                select
                    symbol,
                    company_name,
                    date,
                    linkedin_followers,
                    instagram_followers,
                    instagram_posts,
                    facebook_followers,
                    facebook_page_likes,
                    youtube_followers,
                    youtube_views,
                    twitter_followers,
                    twitter_tweet,
                    ccs,
                    ccr,
                    ccg,
                    total_followers,
                    logo_id,
                    id,
                    logo_url,
                    web,
                    hq,
                    st,
                    div,
                    reg,
                    type
                from
                    reports_data.master_database_table_WEBAPP
                where
                    1 = 1
                    and date = (select max(date) from reports_data.master_database_table_WEBAPP)
                    and ccr <= 24
                    and {{ filters.globalFilter(companyName, div, reg, st, symbol) }}
            ) current_data
            left join (
                select
                    symbol,
                    company_name,
                    date,
                    linkedin_followers,
                    instagram_followers,
                    instagram_posts,
                    facebook_followers,
                    facebook_page_likes,
                    youtube_followers,
                    youtube_views,
                    twitter_followers,
                    twitter_tweet,
                    ccs,
                    ccr,
                    ccg,
                    total_followers,
                    logo_id,
                    id,
                    logo_url,
                    web,
                    hq,
                    st,
                    div,
                    reg,
                    type
                from
                    reports_data.master_database_table_WEBAPP
                where
                    date = date_sub((select max(date) from reports_data.master_database_table_WEBAPP), interval 1 day)
            ) day1
            on (
                current_data.company_name = day1.company_name
            )
            left join (
                select
                    symbol,
                    company_name,
                    date,
                    linkedin_followers,
                    instagram_followers,
                    instagram_posts,
                    facebook_followers,
                    facebook_page_likes,
                    youtube_followers,
                    youtube_views,
                    twitter_followers,
                    twitter_tweet,
                    ccs,
                    ccr,
                    ccg,
                    total_followers,
                    logo_id,
                    id,
                    logo_url,
                    web,
                    hq,
                    st,
                    div,
                    reg,
                    type
                from
                    reports_data.master_database_table_WEBAPP
                where
                    date = date_sub((select max(date) from reports_data.master_database_table_WEBAPP), interval 7 day)
            ) day7
            on (
                current_data.company_name = day7.company_name
            )
            left join (
                select
                    symbol,
                    company_name,
                    date,
                    linkedin_followers,
                    instagram_followers,
                    instagram_posts,
                    facebook_followers,
                    facebook_page_likes,
                    youtube_followers,
                    youtube_views,
                    twitter_followers,
                    twitter_tweet,
                    ccs,
                    ccr,
                    ccg,
                    total_followers,
                    logo_id,
                    id,
                    logo_url,
                    web,
                    hq,
                    st,
                    div,
                    reg,
                    type
                from
                    reports_data.master_database_table_WEBAPP
                where
                    date = date_sub((select max(date) from reports_data.master_database_table_WEBAPP), interval 30 day)
            ) day30
            on (
                current_data.company_name = day30.company_name
            )
    )
